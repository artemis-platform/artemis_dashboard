#!/bin/bash

set -a
source .env
set +a

if [[ $1 = "formatter" ]]; then
  mix format --check-formatted && exit 0
fi

attempts=0

until [ $attempts -ge 5 ]
do
  # xvfb-run -e /dev/stdout -a mix test $@ && exit 0
  if [ $attempts -ge 2 ]; then
    echo "First attempt"
    xvfb-run -e /dev/stdout -a mix test --slowest 10 $@ && exit 0
  else
    echo "Attempt ${attempts}"
    xvfb-run -e /dev/stdout -a mix test --slowest 10 --failed $@ && exit 0
  fi

  attempts=$[$attempts + 1]
done

exit 1
